{% extends "plugin_base.html" %}

{% set plugin_config = {
    'title': 'NDI Control & Streaming',
    'icon': 'üé•',
    'description': 'Manage NDI devices and sources across your network',
    'device_type': 'NDI Device',
    'api_endpoint': 'ndi',
    'active_label': 'Recording'
} %}

{% block plugin_controls %}
<!-- NDI Sources Panel -->
<div class="row mt-3">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>üì° NDI Sources</h5>
                <button type="button" class="btn btn-sm btn-outline-light shadow-hover" id="refreshSourcesBtn">
                    üîÑ Refresh
                </button>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="sourceSelect" class="form-label fw-semibold">Available Sources:</label>
                    <select class="form-select source-select" id="sourceSelect" size="5">
                        <option value="">Loading sources...</option>
                    </select>
                </div>
                <div class="mt-3 p-2 bg-light rounded">
                    <small class="text-muted" id="sourceInfo">
                        <span class="fw-semibold">üí° Tip:</span> Select a source to view details
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Viewer Control Panel -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>üé¨ Viewer Control</h5>
            </div>
            <div class="card-body">
                <div class="btn-group d-flex mb-3" role="group">
                    <button type="button" class="btn btn-success shadow-hover" id="startViewerBtn">
                        <div class="d-flex flex-column align-items-center">
                            <span class="btn-icon">‚ñ∂Ô∏è</span>
                            <small>Start</small>
                        </div>
                    </button>
                    <button type="button" class="btn btn-warning shadow-hover" id="restartViewerBtn">
                        <div class="d-flex flex-column align-items-center">
                            <span class="btn-icon">üîÑ</span>
                            <small>Restart</small>
                        </div>
                    </button>
                    <button type="button" class="btn btn-danger shadow-hover" id="stopViewerBtn">
                        <div class="d-flex flex-column align-items-center">
                            <span class="btn-icon">‚èπÔ∏è</span>
                            <small>Stop</small>
                        </div>
                    </button>
                </div>
                
                <div class="form-group">
                    <button type="button" class="btn btn-outline-primary w-100 shadow-hover" id="setInputBtn">
                        üîÑ Set Input Source
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recording Control Panel -->
<div class="row mt-3">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>üé• Recording Control</h5>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="outputPath" class="form-label fw-semibold">üìÅ Output Path (optional):</label>
                    <input type="text" class="form-control" id="outputPath" placeholder="/tmp/my_recording.mp4">
                    <small class="form-text text-muted">üí° Leave empty for auto-generated filename</small>
                </div>
                
                <div class="btn-group d-flex mt-3" role="group">
                    <button type="button" class="btn btn-danger shadow-hover" id="recordStartBtn">
                        <div class="d-flex flex-column align-items-center">
                            <span class="btn-icon">üî¥</span>
                            <small>Start</small>
                        </div>
                    </button>
                    <button type="button" class="btn btn-secondary shadow-hover" id="recordStopBtn">
                        <div class="d-flex flex-column align-items-center">
                            <span class="btn-icon">‚èπÔ∏è</span>
                            <small>Stop</small>
                        </div>
                    </button>
                </div>
                
                <div class="mt-3">
                    <div id="recordingStatus" class="alert d-none">
                        <strong>üìº Recording Status:</strong> <span id="recordingInfo"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Process Monitor Panel -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>‚öôÔ∏è Process Monitor</h5>
            </div>
            <div class="card-body">
                <button type="button" class="btn btn-info w-100 mb-3 shadow-hover" id="listProcessesBtn">
                    üìã List Running Processes
                </button>
                
                <div id="processInfo" class="p-3 bg-light rounded">
                    <div class="text-center text-muted">
                        <div class="mb-2">üîç</div>
                        <p class="mb-0">Click "List Running Processes" to view active NDI processes</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block quick_actions %}
<div class="row mt-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>‚ö° Quick Actions</h5>
            </div>
            <div class="card-body quick-actions">
                <div class="row g-3">
                    <div class="col-md-3">
                        <button type="button" class="btn btn-outline-primary w-100 shadow-hover" id="statusBtn">
                            <span class="btn-icon">‚ÑπÔ∏è</span>
                            Get Status
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-outline-success w-100 shadow-hover" id="startCurrentBtn">
                            <span class="btn-icon">‚ñ∂Ô∏è</span>
                            Start Current
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-outline-warning w-100 shadow-hover" id="restartCurrentBtn">
                            <span class="btn-icon">üîÑ</span>
                            Restart Current
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-outline-danger w-100 shadow-hover pulse" id="emergencyStopBtn">
                            <span class="btn-icon">‚ö†Ô∏è</span>
                            Emergency Stop
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block plugin_scripts %}
// NDI Plugin Implementation
class NDIPlugin extends StandardPlugin {
    constructor() {
        super({
            title: 'NDI Control & Streaming',
            api_endpoint: 'ndi'
        });
        this.selectedSource = null;
    }
    
    setupPluginEventListeners() {
        // Source selection
        document.getElementById('sourceSelect').addEventListener('change', (e) => {
            this.selectedSource = e.target.value;
            this.updateSourceInfo();
            this.logActivity(`Selected source: ${this.selectedSource}`, 'info');
        });

        // NDI-specific buttons
        document.getElementById('refreshSourcesBtn').addEventListener('click', () => this.loadSources(true));
        document.getElementById('startViewerBtn').addEventListener('click', () => this.startViewer());
        document.getElementById('restartViewerBtn').addEventListener('click', () => this.restartViewer());
        document.getElementById('stopViewerBtn').addEventListener('click', () => this.stopViewer());
        document.getElementById('setInputBtn').addEventListener('click', () => this.setInput());
        
        // Recording controls
        document.getElementById('recordStartBtn').addEventListener('click', () => this.startRecording());
        document.getElementById('recordStopBtn').addEventListener('click', () => this.stopRecording());
        
        // Process monitor
        document.getElementById('listProcessesBtn').addEventListener('click', () => this.listProcesses());
        
        // Quick actions
        document.getElementById('startCurrentBtn').addEventListener('click', () => this.startCurrent());
        document.getElementById('restartCurrentBtn').addEventListener('click', () => this.restartCurrent());
        document.getElementById('emergencyStopBtn').addEventListener('click', () => this.emergencyStop());
        
        // Load sources on initialization
        this.loadSources();
    }
    
    getDeviceExtraInfo(device) {
        let info = '';
        if (device.viewer_running) info += ' (Viewer Running)';
        if (device.recording) info += ' (Recording)';
        return info;
    }
    
    getActiveDeviceCount(devices) {
        return Object.values(devices).filter(d => d.recording || d.viewer_running).length;
    }
    
    getAdditionalStatusRows(device) {
        const viewerStatus = device.viewer_running ? 
            '<span class="badge badge-info">‚ñ∂Ô∏è Running</span>' : 
            '<span class="badge badge-secondary">‚èπÔ∏è Stopped</span>';
            
        const recordingStatus = device.recording ? 
            '<span class="badge badge-danger recording-indicator">Recording</span>' : 
            '<span class="badge badge-light">‚ö™ Not Recording</span>';
        
        return `
            <div class="device-status-row d-flex justify-content-between">
                <strong>üé¨ Viewer:</strong>
                ${viewerStatus}
            </div>
            <div class="device-status-row d-flex justify-content-between">
                <strong>üé• Recording:</strong>
                ${recordingStatus}
            </div>
            <div class="device-status-row d-flex justify-content-between">
                <strong>üì° Current Input:</strong>
                <span class="text-info">${device.current_input || 'None'}</span>
            </div>
            <div class="device-status-row d-flex justify-content-between">
                <strong>üÜî Viewer PID:</strong>
                <code>${device.viewer_pid || 'N/A'}</code>
            </div>
            <div class="device-status-row d-flex justify-content-between">
                <strong>üÜî Record PID:</strong>
                <code>${device.record_pid || 'N/A'}</code>
            </div>
        `;
    }
    
    async loadSources(forceRefresh = false) {
        try {
            const endpoint = forceRefresh ? '/api/ndi/sources/refresh' : '/api/ndi/sources';
            const response = await fetch(endpoint);
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}...`);
            }
            
            const data = await response.json();
            this.renderSourceSelect(data);
            
        } catch (error) {
            console.error('Error loading sources:', error);
            this.logActivity(`Error loading sources: ${error.message}`, 'error');
            this.showSourceSelectError(error);
        }
    }
    
    renderSourceSelect(data) {
        const select = document.getElementById('sourceSelect');
        select.innerHTML = '';
        
        if (data.sources && data.sources.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = data.discovery_error ? `Error: ${data.discovery_error}` : 'No sources found';
            option.disabled = true;
            select.appendChild(option);
        } else if (data.sources) {
            data.sources.forEach(source => {
                const option = document.createElement('option');
                option.value = source;
                option.textContent = source;
                select.appendChild(option);
            });
        } else {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'Invalid response format';
            option.disabled = true;
            select.appendChild(option);
        }
        
        const sourceCount = data.sources ? data.sources.length : 0;
        const message = forceRefresh ? 'Refreshed' : 'Loaded';
        this.logActivity(`${message} ${sourceCount} NDI sources`, 'success');
        
        if (data.discovery_error) {
            this.logActivity(`Source discovery warning: ${data.discovery_error}`, 'warning');
        }
    }
    
    showSourceSelectError(error) {
        const select = document.getElementById('sourceSelect');
        select.innerHTML = '';
        const option = document.createElement('option');
        option.value = '';
        option.textContent = `Error: ${error.message.substring(0, 50)}...`;
        option.disabled = true;
        select.appendChild(option);
    }
    
    updateSourceInfo() {
        const infoDiv = document.getElementById('sourceInfo');
        if (!this.selectedSource) {
            infoDiv.innerHTML = `
                <span class="fw-semibold">üí° Tip:</span> Select a source to view details
            `;
            return;
        }
        
        infoDiv.innerHTML = `
            <span class="fw-semibold">‚úÖ Selected:</span> 
            <span class="text-info fw-bold">${this.selectedSource}</span>
        `;
    }
    
    async startViewer() {
        if (!this.selectedDevice || !this.selectedSource) {
            alert('Please select both a device and source first');
            return;
        }

        try {
            const response = await fetch('/api/ndi/start', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({device_id: this.selectedDevice, source: this.selectedSource})
            });
            
            const data = await response.json();
            if (response.ok) {
                this.logActivity(`Started NDI viewer on ${this.selectedDevice} with source ${this.selectedSource}`, 'success');
                this.updateDeviceStatus();
            } else {
                throw new Error(data.detail || 'Failed to start viewer');
            }
        } catch (error) {
            console.error('Error:', error);
            this.logActivity(`Error starting viewer: ${error.message}`, 'error');
        }
    }
    
    async stopViewer() {
        if (!this.selectedDevice) {
            alert('Please select a device first');
            return;
        }

        try {
            const response = await fetch('/api/ndi/stop', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({device_id: this.selectedDevice})
            });
            
            const data = await response.json();
            if (response.ok) {
                this.logActivity(`Stopped NDI viewer on ${this.selectedDevice}`, 'success');
                this.updateDeviceStatus();
            } else {
                throw new Error(data.detail || 'Failed to stop viewer');
            }
        } catch (error) {
            console.error('Error:', error);
            this.logActivity(`Error stopping viewer: ${error.message}`, 'error');
        }
    }
    
    async restartViewer() {
        if (!this.selectedDevice) {
            alert('Please select a device first');
            return;
        }

        try {
            const response = await fetch('/api/ndi/restart', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({device_id: this.selectedDevice, source: this.selectedSource})
            });
            
            const data = await response.json();
            if (response.ok) {
                this.logActivity(`Restarted NDI viewer on ${this.selectedDevice}`, 'success');
                this.updateDeviceStatus();
            } else {
                throw new Error(data.detail || 'Failed to restart viewer');
            }
        } catch (error) {
            console.error('Error:', error);
            this.logActivity(`Error restarting viewer: ${error.message}`, 'error');
        }
    }
    
    async setInput() {
        if (!this.selectedDevice || !this.selectedSource) {
            alert('Please select both a device and source first');
            return;
        }

        try {
            const response = await fetch('/api/ndi/input', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({device_id: this.selectedDevice, source: this.selectedSource})
            });
            
            const data = await response.json();
            if (response.ok) {
                this.logActivity(`Set input to ${this.selectedSource} on ${this.selectedDevice}`, 'success');
                this.updateDeviceStatus();
            } else {
                throw new Error(data.detail || 'Failed to set input');
            }
        } catch (error) {
            console.error('Error:', error);
            this.logActivity(`Error setting input: ${error.message}`, 'error');
        }
    }
    
    async startRecording() {
        if (!this.selectedDevice) {
            alert('Please select a device first');
            return;
        }

        const outputPath = document.getElementById('outputPath').value.trim();
        
        try {
            const body = {device_id: this.selectedDevice};
            if (this.selectedSource) body.source = this.selectedSource;
            if (outputPath) body.output_path = outputPath;
            
            const response = await fetch('/api/ndi/record/start', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });
            
            const data = await response.json();
            if (response.ok) {
                this.logActivity(`Started recording on ${this.selectedDevice}${outputPath ? ` to ${outputPath}` : ''}`, 'success');
                this.updateRecordingStatus('Recording started', 'success');
                this.updateDeviceStatus();
            } else {
                throw new Error(data.detail || 'Failed to start recording');
            }
        } catch (error) {
            console.error('Error:', error);
            this.logActivity(`Error starting recording: ${error.message}`, 'error');
        }
    }
    
    async stopRecording() {
        if (!this.selectedDevice) {
            alert('Please select a device first');
            return;
        }

        try {
            const response = await fetch('/api/ndi/record/stop', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({device_id: this.selectedDevice})
            });
            
            const data = await response.json();
            if (response.ok) {
                this.logActivity(`Stopped recording on ${this.selectedDevice}`, 'success');
                this.updateRecordingStatus('Recording stopped', 'info');
                this.updateDeviceStatus();
            } else {
                throw new Error(data.detail || 'Failed to stop recording');
            }
        } catch (error) {
            console.error('Error:', error);
            this.logActivity(`Error stopping recording: ${error.message}`, 'error');
        }
    }
    
    async listProcesses() {
        if (!this.selectedDevice) {
            alert('Please select a device first');
            return;
        }

        try {
            const response = await fetch(`/api/ndi/processes/${this.selectedDevice}`);
            const data = await response.json();
            
            if (response.ok) {
                this.logActivity(`Listed processes on ${this.selectedDevice}`, 'success');
                document.getElementById('processInfo').innerHTML = 
                    '<p class="text-info">Process list request sent. Check activity log for results.</p>';
            } else {
                throw new Error(data.detail || 'Failed to list processes');
            }
        } catch (error) {
            console.error('Error:', error);
            this.logActivity(`Error listing processes: ${error.message}`, 'error');
        }
    }
    
    startCurrent() {
        if (!this.selectedDevice) {
            alert('Please select a device first');
            return;
        }
        
        if (!this.selectedSource) {
            alert('No source selected. Please select a source first.');
            return;
        }
        
        this.startViewer();
    }
    
    restartCurrent() {
        this.restartViewer();
    }
    
    emergencyStop() {
        if (!this.selectedDevice) {
            alert('Please select a device first');
            return;
        }
        
        if (confirm('This will stop both viewer and recording. Continue?')) {
            Promise.all([
                this.stopViewer(),
                this.stopRecording()
            ]).then(() => {
                this.logActivity(`Emergency stop executed on ${this.selectedDevice}`, 'warning');
            });
        }
    }
    
    updateRecordingStatus(message, type) {
        const statusDiv = document.getElementById('recordingStatus');
        const infoSpan = document.getElementById('recordingInfo');
        
        statusDiv.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'}`;
        infoSpan.textContent = message;
        statusDiv.classList.remove('d-none');
        
        setTimeout(() => {
            statusDiv.classList.add('d-none');
        }, 5000);
    }
    
    // Override standard methods
    async startDevice() {
        this.startCurrent();
    }
    
    async restartDevice() {
        this.restartCurrent();
    }
    
    async stopDevice() {
        this.emergencyStop();
    }
}

// Initialize the NDI plugin
const ndiPlugin = new NDIPlugin();
{% endblock %}
